<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï½œCross Matrix</title>
    <style>
        /* ç®¡ç†ç”»é¢ãªã®ã§ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤ãƒ€ãƒ¼ã‚¯ã« */
        body {
            background: #0a0b10;
            color: #e7e8ee;
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        h1 {
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #a3a7b5;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            background: #12141b;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.9;
        }

        /* å•†å“ãƒªã‚¹ãƒˆ */
        .item-list {
            margin-top: 40px;
        }

        .item {
            background: #12141b;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item img {
            height: 50px;
            width: 50px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 4px;
        }

        .item-info {
            flex: 1;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
        .auth-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            font-size: 0.8rem;
            padding: 5px 10px;
            text-decoration: none;
            display: inline-block;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div id="auth-section">
        <!-- JSã§ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ -->
    </div>

    <h1>ğŸ“¦ å•†å“ãƒªã‚¹ãƒˆ</h1>

    <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="add-form" class="hidden"
        style="background: #1a1d27; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3>æ–°è¦è¿½åŠ </h3>
        <div class="form-group">
            <label>å•†å“å</label>
            <input type="text" id="name" placeholder="ä¾‹: æ‹¡å¼µãƒ‘ãƒƒã‚¯ã€Œè¦šé†’ã®åˆ»ã€">
        </div>
        <div class="form-group">
            <label>ä¾¡æ ¼ (å††)</label>
            <input type="number" id="price" placeholder="ä¾‹: 500">
        </div>
        <div class="form-group">
            <label>ç”»åƒURL</label>
            <input type="text" id="image" placeholder="ç”»åƒã®ãƒªãƒ³ã‚¯ (https://...)">
            <small style="color: #666;">â€»æ‰‹æŒã¡ã®ç”»åƒãŒãªã„å ´åˆã¯ç©ºæ¬„ã§OKï¼ˆãƒ€ãƒŸãƒ¼ç”»åƒãŒå…¥ã‚Šã¾ã™ï¼‰</small>
        </div>
        <div class="form-group">
            <label>å•†å“èª¬æ˜</label>
            <textarea id="description" rows="3" placeholder="å•†å“ã®èª¬æ˜æ–‡..."></textarea>
        </div>
        <button onclick="addProduct()">å•†å“ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ </button>
    </div>

    <div class="item-list">
        <h2>ç™»éŒ²æ¸ˆã¿å•†å“ä¸€è¦§</h2>
        <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        const token = localStorage.getItem('token');
        const authSection = document.getElementById('auth-section');
        const addForm = document.getElementById('add-form');

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ã‚ˆã£ã¦è¡¨ç¤ºåˆ‡æ›¿
        if (token) {
            // ãƒ­ã‚°ã‚¤ãƒ³ä¸­
            authSection.innerHTML = '<button onclick="logout()" class="auth-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';
        } else {
            // æœªãƒ­ã‚°ã‚¤ãƒ³
            authSection.innerHTML = '<a href="login.html" class="auth-btn" style="background:#d4af37; color:#000;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã¯å¸¸ã«è¡¨ç¤ºï¼ˆç·¨é›†å‰Šé™¤ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰
        addForm.classList.remove('hidden');

        // API URL
        // const API_URL = "https://cross-matrix-shop-api.onrender.com/api/products";
        const API_URL = "http://localhost:3000/api/products";

        // 1. å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadProducts() {
            const list = document.getElementById('list');
            try {
                const res = await fetch(API_URL);
                const products = await res.json();

                list.innerHTML = ""; // ã‚¯ãƒªã‚¢
                products.forEach(p => {
                    // å‰Šé™¤ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤º
                    const deleteBtn = `<button class="delete-btn" onclick="deleteProduct('${p._id}')">å‰Šé™¤</button>`;

                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <img src="${p.image || 'https://placehold.co/100'}" onerror="this.src='https://placehold.co/100'">
                            <div class="item-info">
                                <strong>${p.name}</strong><br>
                                <span style="color:#d4af37">Â¥${p.price}</span>
                            </div>
                        </div>
                        ${deleteBtn}
                    `;
                    list.appendChild(div);
                });
            } catch (err) {
                list.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—: " + err.message;
            }
        }

        // 2. å•†å“ã‚’è¿½åŠ ã™ã‚‹ (èªè¨¼å¿…é ˆ)
        async function addProduct() {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const image = document.getElementById('image').value;
            const description = document.getElementById('description').value;

            if (!name || !price) return alert("å•†å“åã¨ä¾¡æ ¼ã¯å¿…é ˆã§ã™");

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, price, image, description })
                });

                if (res.ok) {
                    alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
                    document.getElementById('name').value = "";
                    document.getElementById('price').value = "";
                    document.getElementById('description').value = "";
                    loadProducts();
                } else {
                    const data = await res.json();
                    alert("ã‚¨ãƒ©ãƒ¼: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
                    if (res.status === 401 || res.status === 403) {
                        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                        logout();
                    }
                }
            } catch (err) {
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
            }
        }

        // 3. å•†å“ã‚’å‰Šé™¤ã™ã‚‹ (èªè¨¼å¿…é ˆ)
        async function deleteProduct(id) {
            if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰")) return;

            try {
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
                    loadProducts();
                } else {
                    alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    if (res.status === 401 || res.status === 403) {
                        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                        logout();
                    }
                }
            } catch (err) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.reload(); // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
        }

        // èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¿
        loadProducts();
    </script>
</body>

</html>